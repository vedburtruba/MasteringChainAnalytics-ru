# 09 Полезные запросы (I): Запросы цен токенов ERC20

В ежедневном анализе данных мы обычно сталкиваемся с некоторыми общими запросами, такими как отслеживание изменений цены токена ERC20, запрос баланса различных токенов ERC20, хранящихся на определенном адресе, и т. д. В справочной документации платформы Dune разделы [некоторые полезные панели данных](https://dune.com/docs/reference/wizard-tools/helpful-dashboards/) и [утилитарные запросы](https://dune.com/docs/reference/wizard-tools/utility-queries/) приводят некоторые примеры, вы можете обратиться к ним. В этом руководстве мы объединяем некоторые типичные потребности, с которыми мы сталкиваемся в своей повседневной жизни, и сортируем для вас некоторые примеры запросов.

## Запрос последней цены отдельного токена ERC20

Токены ERC20 используются в широком разнообразии блокчейн-приложений. DeFi-инициативы облегчают торговлю токенами ERC20. Другие проекты вознаграждают своих сторонников, ранних последователей и команды разработчиков посредством планов распределения и раздачи в обмен на токены ERC20. Данные о ценах для нескольких токенов ERC20 можно найти на таких сайтах, как [CoinGecko](https://www.coingecko.com/). Таблицы 'prices.usd' и 'prices.usd_latest' в Dune позволяют аналитикам данных легко извлекать текущую рыночную стоимость наиболее популярных токенов ERC20 на каждом блокчейне. Существует таблица под названием [prices.usd](https://dune.com/docs/reference/tables/prices/), которая отслеживает цены различных токенов ERC20 минута за минутой. Чтобы облегчить такие действия, как обобщение и сравнение при исследовании проектов, связанных с токенами ERC20, мы можем объединить данные о ценах, чтобы преобразовать количество различных токенов в сумму, указанную в долларах США.

**Получение последней цены отдельного токена ERC20**

Цены в таблице 'prices.usd' регистрируются ежеминутно. Получение самой последней записи зависит от символа токена и соответствующего блокчейна, с которым он связан. В случае, если доступен адрес контракта, его также можно использовать для целей запроса. База данных `usd_latest` предназначена для хранения последней цены каждого токена. Каждый токен представлен одной строкой в таблице. Ниже приведены методы, которые можно использовать для получения последней цены отдельного токена, используя WETH в качестве иллюстративного примера. Для повышения производительности запроса мы ограничиваем извлечение последней части данных, поскольку информация о ценах хранится в одной записи на токен каждую минуту, что приводит к большому количеству записей для каждого токена. Периодически может существовать определенное временное отставание. В настоящем случае мы получаем самую последнюю запись данных за последние шесть часов, чтобы определить доступность цены.

**Используйте стоимость токена для чтения последней информации о ценах в таблице `prices.usd`:**

```sql
select * from prices.usd
where symbol = 'WETH'
    and blockchain = 'ethereum'
    and minute >= now() - interval '6' hour
order by minute desc
limit 1
```

**Используйте адрес смарт-контракта токена для чтения последней цены в таблице `prices.usd`:**

```sql
select * from prices.usd
where contract_address = 0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2   -- WETH
    and minute >= now() - interval '6' hour
order by minute desc
limit 1
```

**Чтение последней информации о ценах из таблиц `prices.usd_latest`:**

```sql
select * from prices.usd_latest
where symbol = 'WETH'
    and blockchain = 'ethereum'
```

Запрос проще для чтения из таблицы `prices.usd_latest`, но поскольку она фактически является представлением таблицы `prices.usd`, ее выполнение немного менее эффективно.
Исходный код справки: [prices_usd _latest](https://github.com/dizunalytics/spellbook/blob/main/models/prices_usd.latest.sql)
## Проверьте последние цены на несколько токенов ERC20

Когда нам нужно получить последние цены на несколько токенов одновременно, проявляется удобство таблицы `prices.usd_latest`. Здесь мы возьмем последний запрос цены WETH, WBTC и USDC в качестве примера.


**Прочитайте последнюю информацию о ценах на несколько токенов из таблицы `prices.usd_latest`:**

``` sql
select * from prices.usd_latest
where symbol in ('WETH', 'WBTC', 'USDC')
    and blockchain = 'ethereum'
```

**Прочитайте последнюю информацию о ценах на несколько токенов из таблицы `prices.usd`:**

``` sql
select symbol, decimals, price, minute
from (
    select row_number() over (partition by symbol order by minute desc) as row_num, *
    from prices.usd
    where symbol in ('WETH', 'WBTC', 'USDC')
        and blockchain = 'ethereum'
        and minute >= now() - interval '6' hour
    order by minute desc
) p
where row_num = 1
```

Поскольку мы хотим получить последние цены на несколько токенов одновременно, мы не можем просто использовать предложение `limit` для ограничения количества результатов, чтобы получить желаемые результаты. Нам фактически нужно вернуть первую запись после каждой различной монеты, отсортированной в порядке убывания по полю `minute`. В приведенном выше запросе мы использовали `row_number() over (partition by symbol order by minute desc) as row_num` для создания нового столбца. Значения в этом столбце группируются по `symbol` и сортируются в порядке убывания по полю `minute` - то есть каждая различная монета будет генерировать свою последовательность значений номера строки, таких как 1, 2, 3, 4 и т. д. Мы помещаем это в подзапрос и фильтруем запись `where row_num = 1` во внешнем запросе, которая является последней записью для каждой монеты. Этот метод кажется немного сложным, но подобные запросы часто используются в практических приложениях, и новые столбцы генерируются с помощью функции `row_number()`, а затем используются для фильтрации данных.
