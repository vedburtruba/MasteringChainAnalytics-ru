# 22 Как создать книгу заклинаний

Книга заклинаний — это слой преобразования данных, созданный совместно сообществом Dune. Заклинания — это расширенные абстрактные представления или таблицы, созданные совместными усилиями команды Dune и пользователей сообщества.

Создавая заклинания, все пользователи сообщества Dune могут гораздо легче выполнять анализ данных. Создание заклинаний имеет много преимуществ. Представьте:

- У вас есть несколько запросов, содержащих одни и те же подзапросы или CTE
- Несколько запросов используют очень длинные статические списки данных
- Один из ваших запросов был скопирован или откопирован несколько раз
- Ваш запрос содержит очень сложную логику, которая может быть использована в другом месте

Если один из вышеперечисленных сценариев применим, мы можем преобразовать этот запрос в заклинание, создав представление. Это может упростить логику SQL-запросов, повысить согласованность и поддерживаемость, а также прояснить показатели данных.

Проект Spellbook с открытым исходным кодом, поддерживаемый Dune, может автоматически создавать и поддерживать эти заклинания. Любой в сообществе может внести заклинания в проект Spellbook. Этот учебник пытается написать простое заклинание, чтобы помочь всем легко начать.

## Основные шаги для создания заклинания

В самых простых терминах, заклинание — это по сути оператор `SELECT` запроса. Но конкретный процесс создания заклинания на самом деле включает в себя несколько аспектов и нескольких шагов, которым необходимо следовать шаг за шагом в соответствии с документацией, чтобы успешно создать заклинание.

Основные шаги для создания заклинания включают в себя:

- **Определите объект данных**: исходя из приведенных выше примеров сценариев, в сочетании с конкретными проблемами и потребностями, с которыми вы сталкиваетесь при написании запросов, определите объект данных, который необходимо обработать для создания и генерации заклинания, и определите режим (схему) для выходного заклинания.
- **Настройте источники данных**: источник данных относится к исходным таблицам данных и проанализированным таблицам данных, от которых зависит заклинание. Их необходимо определить в YAML-файле. Каждый источник данных должен быть определен только один раз в заклинании.
- **Напишите тесты**: прежде чем писать заклинание, рассмотрите желаемые результаты запроса и напишите соответствующие тесты на основе этих результатов. Конечно, если наше заклинание является всего лишь представлением агрегированных данных, тест можно добавить после написания заклинания.
- **Напишите заклинание**: используйте файл `.sql` с определенным специальным форматом (шаблон JINJA) для создания каждого заклинания, которое необходимо создать, с помощью оператора `SELECT`. Скомпилируйте и протестируйте заклинание.
- **Отправьте PR**: после написания заклинания, успешной его локальной компиляции и ручного тестирования, создайте новый PR (Pull Request) на GitHub и дождитесь рассмотрения и слияния техническим персоналом Dune. После успешного слияния мы сможем найти только что созданное заклинание в редакторе запросов.

Dune предоставляет более подробные инструкции в своей онлайн-документации: [Руководство по заклинаниям](https://dune.com/docs/zh/spellbook/getting-started/)

## Подготовка к созданию магической таблицы

Перед тем, как приступить к созданию магической таблицы, вам необходимо выполнить некоторые важные подготовительные работы, включая ознакомление с базовым использованием инструмента dbt, изучение основных операций с GitHub (у вас должна быть учетная запись GitHub) и настройка вашей локальной рабочей среды. Подробные требования и инструкции по настройке среды можно найти здесь:

[Подготовьте предварительные требования и настройте Spellbook dbt](https://dune.com/docs/spellbook/1-do-some-prerequisites%20and-set-up-Spellbook-dbt/)

Для получения дополнительной информации о DBT:

[Что такое dbt?](https://docs.getdbt.com/docs/introduction)

Мы предполагаем, что вы уже настроили необходимое программное обеспечение, следуя инструкциям в ссылках выше, и скопировали репозиторий Dune Spellbook (https://github.com/duneanalytics/spellbook) в свою учетную запись GitHub. Ниже кратко описаны следующие шаги. Я использую локально операционную систему Mac, поэтому приведенные здесь примеры относятся к среде Mac. Если вы используете среду Windows и столкнулись с какими-либо проблемами в процессе, пожалуйста, задавайте вопросы в группе.

Используйте команду `git clone` для клонирования скопированного репозитория на ваш локальный компьютер. Создайте новую рабочую директорию на вашем локальном компьютере. Перейдите в эту директорию и используйте следующую команду для клонирования (скопируйте адрес из страницы скопированного репозитория на GitHub, как показано на изображении ниже):

```
git clone git@github.com:springzh/spellbook.git
```

![](img/ch22_image_00.jpg)

После клонирования репозитория вы получите новую поддиректорию с именем `spellbook`. Перейдите в эту директорию:

```
cd spellbook
```

После завершения клонирования вы увидите новую поддиректорию `spellbook` в вашей рабочей директории. Перейдите в эту поддиректорию:

```
cd spellbook
```

Если вы ранее не выполняли `pipenv install` для создания локальной среды pipenv, вам необходимо выполнить установку:

```
pipenv install
```

Если вышеуказанная команда выдает ошибку, попробуйте следующее:

```
sudo -H pip install -U pipenv
```

Если команда возвращает следующую ошибку:

```
pipenv install возвращает предупреждение LANG, предупреждение Python 3.9 не найден
```

Попробуйте установить заново, указав версию Python:

```
pipenv install --python 3.9.13
```

Вы можете использовать эту команду, чтобы проверить установленную версию Python на вашем локальном компьютере:

```
python3 -version
```

После установки среды pipenv вы можете ее активировать:

```
pipenv shell
```

Далее выполните команду `dbt init` для инициализации dbt. Эта команда проведет вас через интерактивную настройку dbt. Подробные инструкции можно найти в ссылке, указанной в разделе "Подготовьте предварительные требования и настройте Spellbook dbt."

```
dbt init
```

После того, как мы закончим написание магической таблицы или внесем какие-либо изменения в связанные файлы, мы используем `dbt compile` для компиляции всего проекта dbt и регенерации SQL для магической таблицы.

Чтобы избежать путаницы, давайте снова перечислим основные шаги:

**Шаги первоначальной инициализации и выполнения:**

```
# Установите среду pipenv
pipenv install

# Активируйте среду pipenv
pipenv shell

# Инициализируйте dbt
dbt init

# Добавьте или измените файлы

# Скомпилируйте dbt
dbt compile
```

**Последующие ежедневные шаги выполнения после инициализации:**

```
# Активируйте среду pipenv
pipenv shell

# Добавьте или измените файлы

# Скомпилируйте dbt
dbt compile
```

При написании и отладке новой магической таблицы вам, возможно, потребуется несколько раз корректировать и изменять связанные файлы. В этом случае вы можете выполнить `dbt compile` несколько раз. Если возникнут какие-либо ошибки компиляции, внесите необходимые изменения на основе сообщений об ошибках. После успешной компиляции скопируйте сгенерированные операторы SQL в Dune для фактического тестирования запросов, чтобы убедиться, что SQL работает правильно и дает ожидаемые результаты.

## Волшебная таблица для создания в этом уроке

Цель этого урока – дать возможность каждому быстро научиться создавать волшебную таблицу, используя простой пример. Ранее, когда Space ID на BNB chain запустил регистрацию доменов, я создал информационную панель данных Space ID ([SpaceID - BNB Domain](https://dune.com/sixdegree/bnb-domain-spaceid)). В то время у Space ID было только ограниченное разрешение на Mint, и пользователи предоставляли много обратной связи, а также предлагали улучшения касательно правил Mint. В ответ на эту обратную связь команда SpaceID постоянно улучшала и обновляла свои смарт-контракты. В течение нескольких дней контракт для регистрации доменов прошел пять основных версий, от V3 до V7. Это привело к проблеме, когда, чтобы консолидировать все зарегистрированные данные доменов Space ID, приходилось запрашивать данные отдельно из таблиц логов событий различных версий контракта и вручную объединять их с помощью операций "Union All". Если вы посмотрите на исходный код запросов к моей информационной панели данных, вы обнаружите, что большинство из них имеют длинное CTE (Common Table Expression) для агрегирования и объединения событий регистрации доменов из разных версий контракта. Например: https://dune.com/queries/1239514/2124307. Чтобы поддерживать ее в актуальном состоянии, мне приходилось вносить многочисленные изменения в эти запросы по одному, включая включение данных из новых версий контракта. Фактически, проект Space ID теперь имеет версии контракта для регистрации доменов V8 и V9, которые не включены в мою панель, что делает ее устаревшей. Если другие пользователи форкнули мои запросы и внесли корректировки, к сожалению, их запросы также устарели.

[Изображение: img/ch22_image_01.jpg]

В таком случае, если мы создадим волшебную таблицу для событий регистрации доменов (фактически представление), все запросы можно будет писать непосредственно на основе этой волшебной таблицы. Когда будет выпущена новая версия смарт-контракта, нам нужно будет только изменить и обновить определение волшебной таблицы и отправить PR (Pull Request) на проверку. Как только PR будет одобрен и объединен, данные в волшебной таблице будут автоматически обновлены. Все запросы, использующие эту волшебную таблицу, не потребуют никаких изменений. В отличие от этого, без волшебной таблицы, мои запросы, а также запросы, сгенерированные другими пользователями, которые форкнули мои запросы, должны быть изменены по одному. Из этого мы можем видеть преимущества создания волшебной таблицы.

Итак, что мы собираемся сделать здесь, так это создать волшебную таблицу, которая включает в себя всю информацию о регистрации доменов Space ID на блокчейне `bnb` проекта `spaceid`.
## Создание структуры каталогов и файлов

Как только мы определили, какую магическую таблицу мы хотим создать, мы можем приступить к работе над ней. При использовании Git — хорошей практикой является всегда разрабатывать в отдельной ветке. Я рекомендую всем придерживаться этого подхода. Давайте создадим новую рабочую ветку под названием `add_bnb_spaceid` в локальном клонированном репозитории заклинательной книги:

```
git checkout -b add_bnb_spaceid
```

Теперь мы автоматически переключены на новую рабочую ветку Git `add_bnb_spaceid`. Мы можем начать создавать структуру каталогов и файлы, необходимые для магической таблицы.

Для магических таблиц на основе проектов они хранятся в каталоге `/spellbook/models` с использованием формата `[название_проекта]/[название_блокчейна]. Все имена должны быть в нижнем регистре, а слова должны быть разделены подчеркиваниями. Например: `/spellbook/models/[название_проекта]/[название_блокчейна]`. В данном случае название нашего проекта — `spaceid`, а название блокчейна — `bnb`, поэтому полная структура каталогов для нашей магической таблицы: `/spellbook/models/spaceid/bnb/`.

Пожалуйста, перейдите в каталог `models` и создайте подкаталог под названием `spaceid` внутри него. Затем перейдите внутрь этого вновь созданного каталога и создайте еще один подкаталог под названием `bnb`.

Файлы магической таблицы должны быть названы следующим образом:

- Для файлов схемы: `[название_проекта]_[название_блокчейна]_schema.yml
- Для файлов исходных данных зависимостей: `[название_проекта]_[название_блокчейна]_sources.yml
- Для SQL файла магической таблицы: `[название_проекта]_[название_блокчейна]_[название_заклинания].sql

Здесь `название_заклинания` - это имя магической таблицы, которую мы хотим создать. Мы будем использовать `registrations` в качестве имени.

Итак, нам нужно создать следующие три соответствующих файла (оставьте содержимое файла пустым на данный момент; мы объясним каждый из них позже) в каталоге `spaceid/bnb/`:

- spaceid_bnb_schema.yml
- spaceid_bnb_sources.yml
- spaceid_bnb_registrations.sql

Текущая структура каталогов и файлов должна выглядеть следующим образом:

![](img/ch22_image_02.jpg)

Ссылка на документ: [Настройте структуру ваших файлов для SQL, схемы и исходных файлов](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/3-set-up-your-file-structure-for-SQL-schema-and-source-files/)
