# 22 Как создать книгу заклинаний

Книга заклинаний — это слой преобразования данных, созданный совместно сообществом Dune. Заклинания — это расширенные абстрактные представления или таблицы, созданные совместными усилиями команды Dune и пользователей сообщества.

Создавая заклинания, все пользователи сообщества Dune могут гораздо легче выполнять анализ данных. Создание заклинаний имеет много преимуществ. Представьте:

- У вас есть несколько запросов, содержащих одни и те же подзапросы или CTE
- Несколько запросов используют очень длинные статические списки данных
- Один из ваших запросов был скопирован или откопирован несколько раз
- Ваш запрос содержит очень сложную логику, которая может быть использована в другом месте

Если один из вышеперечисленных сценариев применим, мы можем преобразовать этот запрос в заклинание, создав представление. Это может упростить логику SQL-запросов, повысить согласованность и поддерживаемость, а также прояснить показатели данных.

Проект Spellbook с открытым исходным кодом, поддерживаемый Dune, может автоматически создавать и поддерживать эти заклинания. Любой в сообществе может внести заклинания в проект Spellbook. Этот учебник пытается написать простое заклинание, чтобы помочь всем легко начать.

## Основные шаги для создания заклинания

В самых простых терминах, заклинание — это по сути оператор `SELECT` запроса. Но конкретный процесс создания заклинания на самом деле включает в себя несколько аспектов и нескольких шагов, которым необходимо следовать шаг за шагом в соответствии с документацией, чтобы успешно создать заклинание.

Основные шаги для создания заклинания включают в себя:

- **Определите объект данных**: исходя из приведенных выше примеров сценариев, в сочетании с конкретными проблемами и потребностями, с которыми вы сталкиваетесь при написании запросов, определите объект данных, который необходимо обработать для создания и генерации заклинания, и определите режим (схему) для выходного заклинания.
- **Настройте источники данных**: источник данных относится к исходным таблицам данных и проанализированным таблицам данных, от которых зависит заклинание. Их необходимо определить в YAML-файле. Каждый источник данных должен быть определен только один раз в заклинании.
- **Напишите тесты**: прежде чем писать заклинание, рассмотрите желаемые результаты запроса и напишите соответствующие тесты на основе этих результатов. Конечно, если наше заклинание является всего лишь представлением агрегированных данных, тест можно добавить после написания заклинания.
- **Напишите заклинание**: используйте файл `.sql` с определенным специальным форматом (шаблон JINJA) для создания каждого заклинания, которое необходимо создать, с помощью оператора `SELECT`. Скомпилируйте и протестируйте заклинание.
- **Отправьте PR**: после написания заклинания, успешной его локальной компиляции и ручного тестирования, создайте новый PR (Pull Request) на GitHub и дождитесь рассмотрения и слияния техническим персоналом Dune. После успешного слияния мы сможем найти только что созданное заклинание в редакторе запросов.

Dune предоставляет более подробные инструкции в своей онлайн-документации: [Руководство по заклинаниям](https://dune.com/docs/zh/spellbook/getting-started/)
