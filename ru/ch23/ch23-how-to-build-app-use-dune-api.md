# 23 Создание приложения с использованием API Dune

## Обзор проекта

25 апреля Dune официально открыла доступ к API для всех уровней пользователей, включая бесплатных пользователей. Теперь даже бесплатные пользователи могут получить доступ к API Dune. Этот учебный материал предоставляет демонстрацию, показывающую, как разрабатывать приложение вокруг API Dune.

Демонстрационное приложение развернуто здесь: [Watcher Demo](https://dev.lentics.xyz/).

Демонстрационное приложение было завершено в начале марта, но из-за различных причин учебный материал был отложен до настоящего времени. Мы приносим извинения за задержку. Код проекта был совместно завершен нашими коллегами Джорджем, Кеном и Бенни. Мы выражаем им нашу благодарность.

Пожалуйста, обратите внимание, что вышеуказанное демонстрационное приложение может работать не постоянно из-за ограничений API Key. Мы рекомендуем сделать форк проекта и развернуть его самостоятельно, используя свой собственный API Key, чтобы продолжить изучение.

Пользовательский интерфейс проекта показан на следующем изображении:

![](img/ch23_watcher01.jpg)

## Введение в использование Dune API

Dune API выполняется и результаты получаются на основе Query ID. Каждый сохраненный Query может быть автоматически преобразован в конечную точку доступа API. В последней версии интерфейса Query Editor вам нужно просто написать запрос, протестировать его функциональность, сохранить запрос, а затем нажать кнопку "API Endpoint", чтобы получить URL конечной точки API для доступа к результатам запроса.

```
https://api.dune.com/api/v1/query/2408388/results?api_key=<api_key>
```

Это самый простой способ доступа к набору результатов сохраненного запроса через API.

[Изображение img/ch23_watcher02.jpg]

Результат выполнения Query по умолчанию кэшируется. Если вы не выполняете Query повторно, конечная точка API, указанная выше, предоставит кэшированный результат последнего выполнения. Обычно нашим приложениям необходимо активно выполнять запросы для получения самых последних данных, соответствующих условиям, а не повторно получать кэшированные наборы результатов. Это особенно верно для приложений мониторингового типа. Поэтому нам также необходимо обращаться к конечной точке "Execute" для выполнения запроса и к конечной точке "Status" для проверки статуса выполнения запроса. Получив информацию о том, что запрос выполнен, мы можем обращаться к конечной точке "Results" для получения данных.

Полный процесс вызова API включает выполнение запроса, проверку статуса выполнения запроса и получение результатов запроса. Подробные объяснения о Dune API можно найти в документации API: [Dune API](https://dune.com/docs/api/api-reference/#latest-results-endpoint).

## Требования к проекту

Чтобы максимально полно продемонстрировать полный процесс разработки проекта с использованием Dune API, организованы следующие основные пункты требований.

Основная функция этого приложения – предоставить чистое клиентское приложение для мониторинга создания новых пулов ликвидности на основе Dune API, в частности, для Uniswap V3. Оно использует базу данных для сохранения выбранных пользователем адресов отслеживаемых пулов и реализует кэширование, чтобы избежать выполнения запросов API для получения точно идентичных данных.

Приложение включает в себя три основные функциональности:

1. **Новые пулы**
   
    Возвращает список недавно созданных пулов ликвидности, соответствующих выбранным критериям блокчейна и диапазона дат. При вызове API пользователь выбирает название блокчейна (в нижнем регистре) и параметры даты (ГГГГ-ММ-ДД, преобразуемые в конкретные даты в соответствии с выбором пользователя).

2. **Последние свопы**

    Отображает 100 последних записей об обменах свопов для пула, выбранного из списка пулов в новом интерфейсе. Пользователь переходит в этот интерфейс, щелкнув по ссылке "Последний своп" рядом с конкретным пулом из предыдущего шага. При вызове API пользователь предоставляет название блокчейна, адрес пула и текущее значение часа (ГГГГ-ММ-ДД ЧЧ:ММ:СС, преобразуемое в конкретные дату и час, например, "2023-02-27 09:00:00"). Вызов API возвращает результаты, которые отображаются в виде списка.

3. **Оповещения о крупных свопах**

    Позволяет пользователю ввести адрес пула (предлагая пользователю скопировать его из списка пулов) и установить порог для крупных свопов (например, 1000 USD). Приложение затем вызывает API каждые 5 минут и генерирует локальное оповещение, если есть записи о свопах, соответствующие указанному условию. Пользователь может установить адрес пула для мониторинга и минимальную сумму свопа в долларах США (в настоящее время предлагается три варианта: 1000, 10000 и 100000). Если API возвращает данные, они будут добавлены к локальному оповещению. Красный значок в панели навигации будет указывать на количество непрочитанных оповещений, а щелчок по нему отобразит список. После щелчка по отдельному оповещению оно будет помечено как прочитанное.
## Настройка среды разработки

``` bash
Копировать код
yarn dev
```

Для других команд обратитесь к файлу `readme.md` в исходном коде проекта.
## Обзор разработки

### Создание проекта

Проект основан на Next.js, используя tailwindcss в качестве CSS-фреймворка, Axios в качестве загрузчика, dexie для операций с данными на стороне клиента и prisma для операций с данными на стороне сервера.

```
$ yarn create next-app
$ yarn add tailwindcss autoprefixer postcss prisma -D
$ yarn add axios dexie dexie-react-hooks @prisma/client
```

### Инициализация схемы

``` bash
$ yarn prisma init --datasource-provider sqlite
$ vim prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model DuneQuery {
  id           String   @unique
  execution_id String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

$ yarn prisma migrate dev --name init
$ yarn prisma generate
```

### Инкапсуляция API вызовов

Добавьте `lib/dune.ts` для инкапсуляции трех шагов выполнения API Dune:

``` javascript
export const executeQuery = async (id: string, parameters: any) => {
  // Generate a hash for the current execution query key, check and get the corresponding execution_id from sqlite. Remember to handle cache expiration.
  // ...
};

export const executeStatus = async (id: string) => {
  // ...
};

export const executeResults = async (id: string) => {
  // ...
};
```

### Отображение данных на стороне клиента

В каталоге `pages` добавьте рекурсивную функцию для проверки существования узла `data.result` для использования в рекурсивных вызовах. Активируйте ее в `useEffect`.

### Развертывание кода

Процесс развертывания аналогичен проекту Next.js. Инициализация базы данных уже размещена в `package.json`:

``` json
"scripts": {
  "dev": "prisma generate && prisma migrate dev && next dev",
  "build": "prisma generate && prisma migrate deploy && next build",
  "start": "next start"
}
```

### Написание SQL запросов для API

API вызовы и соответствующая информация о запросах:

- New Pools: https://dune.com/queries/2056212
- Latest Swap: https://dune.com/queries/2056310
- Alerts: https://dune.com/queries/2056547

### Важные функциональные моменты

1. Dune API требует выполнения `Execute Query ID` для получения `execution_id` перед выполнением `status/results`. Правильно обрабатывайте истечение срока действия кэша.
2. Клиентскому коду необходимо выполнять рекурсивные вызовы к системному API для получения результатов.

## Документация API Dune

- Китайская документация: https://dune.com/docs/zh/api/
- Последняя версия: https://dune.com/docs/api/