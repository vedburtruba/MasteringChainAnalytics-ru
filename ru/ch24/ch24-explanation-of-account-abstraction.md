## Объяснение Абстракции Аккаунтов

## Введение в Абстракцию Аккаунтов

Ethereum имеет два типа аккаунтов: внешние аккаунты (EOA) и аккаунты контрактов (CA), или смарт-контракты.

- EOA — это аккаунты, контролируемые пользователем, которые могут отправлять транзакции. Пользователи поддерживают владение своими аккаунтами посредством своих приватных ключей и могут выполнять транзакции, подписывая их, тем самым изменяя внутреннее состояние своих EOA или состояние внешних аккаунтов контрактов.
Поскольку приватный ключ (или фраза восстановления) является единственным представлением владения EOA, EOA не подходят для определения сложной логики владения или транзакций, такой как социальный вход и транзакции с несколькими подписями. Ограничения EOA приводят к плохому пользовательскому опыту;
некоторые громоздкие шаги, такие как управление приватными ключами и фразой восстановления, напрямую препятствуют пользователям Web2 от входа в Web3. Большинство популярных кошельков, такие как MetaMask, основаны на модели EOA.

- CA могут размещать произвольный код Solidity, тем самым используя полную вычислительную полноту EVM. К сожалению, аккаунты контрактов не могут отправлять транзакции, поэтому их функциональность должна быть вызвана EOA.
Кошелек смарт-контракта — это тип аккаунта контракта, который косвенно вызывается его пользователем через сети EOA поставщиков кошельков, будь то через релеи или бандлеры.

**Абстракция аккаунтов (AA)**, суть которой заключается в отвязывании полномочий по подписи и владения аккаунтами, позволяя для более гибких комбинаций CA и EOA, тем самым обеспечивая такие функции, как абстракция газа, программируемые разрешения и т. д. с помощью кода смарт-контракта.

Стандарт ERC4337 является мерой для реализации Абстракции аккаунтов без изменения консенсусного уровня Ethereum, и он также является предложением с наибольшей осуществимостью. За последний год также появилось большое количество приложений, основанных на этом протоколе.
Серия статей по анализу данных абстракции аккаунтов все сосредоточены вокруг этого стандарта.
## Поток выполнения ERC4337

В реализации стандарта абстракции аккаунтов ERC4337 задействованы четыре роли:

- Пользователь: владелец смарт-кошелька, соответствующий контракту смарт-кошелька.
- Объединитель (Bundler): отвечает за отправку информации о транзакциях, отправленной пользователем, в контракт точки входа (EntryPoint). Это EOA аккаунты.
- Плательщик газа (Paymaster): отвечает за оплату комиссий за газ для операций, но это необязательно. Если не установлен, газ оплачивается смарт-кошельком.
- Фабрика кошельков (Wallet Factory): отвечает за создание новых смарт-кошельков.



Конкретный поток выполнения следующий:

1. Пользователь отправляет Пользовательские операции через кошелек с поддержкой абстракции аккаунтов, эти Пользовательские операции попадают в Альт Mempool;
2. Объединитель отслеживает этот Mempool, извлекает Пользовательские операции из него и отправляет эти операции в контракт точки входа;
3. Если в этом кошельке есть поле initcode, будет вызван контракт фабрики для развертывания нового контракта смарт-кошелька;
4. Если поля initcode нет, будет вызван смарт-кошелек для выполнения конкретной операции;
5. На этапах 3 и 4, если пользователь указал плательщика газа в Пользовательской операции, то ETH поступает от плательщика газа. В противном случае газ оплачивается кошельком.

![](./img/erc4337-flow.png)