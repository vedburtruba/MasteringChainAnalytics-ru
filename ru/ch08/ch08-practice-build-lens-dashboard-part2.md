# 08 Практика – Создание панели управления Lens (II)

В первой части этого учебного пособия мы познакомили вас с протоколом Lens и создали предварительную панель управления для него, анализируя общее количество транзакций и общее количество пользователей, количество транзакций и количество уникальных пользователей в день, данные профиля создателя, анализ доменных имен Lens, поиск зарегистрированных доменных имен и другой связанный контент. Давайте добавим новые запросы и визуализации на эту панель управления. Мы проанализируем и добавим следующее содержимое: создание нескольких профилей с одного адреса, данные о подписке, данные о публикациях, данные о комментариях, данные о коллекциях, данные о зеркалировании, комплексное управление профилями и комплексное управление обычными адресами пользователей.

## Создание нескольких профилей с одного адреса

Протокол Lens позволяет создавать несколько профилей для одного адреса. Мы можем написать запрос для подсчета распределения данных адресов с несколькими созданными профилями. В следующем запросе мы сначала используем CTE profile_created для получения деталей всех созданных профилей, а затем используем multiple_profiles_addresses для подсчета количества профилей, созданных для каждого адреса. Наконец, мы используем оператор CASE для возврата агрегированной статистики, сортируя каждый адрес по количеству созданных профилей.

``` sql
with profile_created as (
    select json_value(vars, 'lax $.to') as user_address,
        json_value(vars, 'lax $.handle') as handle_name,
        replace(json_value(vars, 'lax $.handle'), '.lens', '') as short_name,
        call_block_time,
        output_0 as profile_id,
        call_tx_hash
    from lens_polygon.LensHub_call_createProfile
    where call_success = true    
),

multiple_profiles_addresses as (
    select user_address,
        count(profile_id) as profile_count
    from profile_created
    group by 1
    order by 2 desc
)

select (case when profile_count >= 10 then '10+ Profiles'
            when profile_count >= 3 then '5+ Profiles'
            when profile_count = 2 then '2 Profiles'
            else '1 Profile'
        end) as profile_count_type,
    count(user_address) as user_address_count,
    sum(profile_count) as profile_count
from multiple_profiles_addresses
group by 1
```

При выполнении этого вида статистики данных, мы обычно также нуждаемся в получении некоторых статистических значений типа Counter, таких как общее количество адресов, которые создали несколько профилей, сколько профилей создано этими адресами и доля этих профилей от общего количества созданных профилей и т.д. Вышеуказанный подзапрос CTE может быть использован при запросе этих данных, поэтому мы внесли небольшие изменения и добавили два дополнительных CTE для подсчета значений этих Counter типов. Добавьте визуальную диаграмму для этого запроса и добавьте ее на панель управления данными соответственно. Эффект отображения выглядит следующим образом:

![](img/ch08_image_09.png)

Ссылка на референс для вышеуказанного запроса на Dune:
- [https://dune.com/queries/1562662](https://dune.com/queries/1562662)
- [https://dune.com/queries/1553030](https://dune.com/queries/1553030)